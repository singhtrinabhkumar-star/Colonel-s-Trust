<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Colonel’s Trust</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b141a; --panel: #111b21; --accent: #00a884; --text: #e9edef;
      --muted: #8696a0; --error: #ff4d4f; --me: #005c4b; --them: #202c33;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text); display: grid; place-items: center; min-height: 100vh; }
    .card { width: 100%; max-width: 960px; background: var(--panel); border-radius: 12px; overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: grid; grid-template-columns: 320px 1fr; min-height: 600px; }
    .left { border-right: 1px solid #1f2c33; display: flex; flex-direction: column; }
    .right { display: flex; flex-direction: column; }
    header { padding: 16px; border-bottom: 1px solid #1f2c33; display: flex; align-items: center; gap: 12px; }
    header .title { font-weight: 600; }
    header .status { font-size: 12px; color: var(--muted); }
    .section { padding: 16px; display: grid; gap: 12px; }
    label { font-size: 14px; color: var(--muted); }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #1f2c33; background: #0b141a; color: var(--text); outline: none;
    }
    button { background: var(--accent); color: #062b26; border: none; padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    button.secondary { background: #1f2c33; color: var(--text); }
    .error { color: var(--error); font-size: 13px; }
    .hidden { display: none !important; }
    .chat-header { padding: 12px 16px; border-bottom: 1px solid #1f2c33; display: flex; align-items: center; justify-content: space-between; }
    .chat-header .peer { font-weight: 600; }
    .chat-header .actions { display: flex; gap: 8px; }
    .messages { flex: 1; overflow-y: auto; padding: 16px; display: grid; gap: 8px; }
    .msg { max-width: 70%; padding: 8px 12px; border-radius: 12px; line-height: 1.3; word-wrap: break-word; white-space: pre-wrap; font-size: 14px; }
    .msg.me { background: var(--me); justify-self: end; }
    .msg.them { background: var(--them); justify-self: start; }
    .msg .meta { margin-top: 6px; font-size: 11px; color: var(--muted); }
    .composer { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px; border-top: 1px solid #1f2c33; }
    .file-list { display: grid; gap: 6px; font-size: 13px; color: var(--muted); padding: 0 12px 12px; border-top: 1px dashed #1f2c33; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #1f2c33; color: var(--text); font-size: 12px; }
    .call-panel { padding: 12px; border-top: 1px solid #1f2c33; display: grid; gap: 8px; }
    audio { width: 100%; }
  </style>
</head>
<body>
  <div class="card">
    <div class="left">
      <header>
        <div>
          <div class="title">Colonel’s Trust</div>
          <div class="status" id="status">Not logged in</div>
        </div>
      </header>

      <!-- Step 1: Code -->
      <div class="section" id="step-code">
        <label>Enter your code</label>
        <input type="number" id="code-input" />
        <button id="code-next">Continue</button>
        <div class="error" id="code-error"></div>
      </div>

      <!-- Step 2: Name -->
      <div class="section hidden" id="step-name">
        <label>Enter your desired name:</label>
        <input type="text" id="name-input" />
        <button id="name-login">Log in</button>
        <button class="secondary" id="name-back">Back</button>
        <div class="error" id="name-error"></div>
      </div>

      <!-- Profile -->
      <div class="section hidden" id="profile">
        <div><span class="pill">You</span> <strong id="me-name"></strong></div>
        <div><span class="pill">Code</span> <span id="me-code"></span></div>
        <div><span class="pill">Peer</span> <span id="peer-name"></span></div>
        <button id="logout" class="secondary">Log out</button>
      </div>
    </div>

    <div class="right">
      <div class="chat-header">
        <div>
          <div class="peer" id="chat-peer">No peer</div>
          <div class="status" id="presence"></div>
        </div>
        <div class="actions">
          <button id="start-call">Call</button>
          <button id="end-call" class="secondary">End</button>
        </div>
      </div>

      <div class="messages" id="messages"></div>
      <div class="file-list" id="file-list"></div>

      <div class="composer">
        <input type="text" id="msg-input" />
        <input type="file" id="file-input" />
        <button id="send-btn">Send</button>
      </div>

      <div class="call-panel">
        <audio id="remote-audio" autoplay></audio>
      </div>
    </div>
  </div>

  <script>
    const VALID_CODES = ["18123", "141613"];
    const NAME_BY_CODE = { "18123": "RAW", "141613": "NPM" };
    const CHANNEL_NAME = "colonels-trust-channel";

    let me = null;
    let peer = null;
    let channel = null;

    let pc = null;
    let localStream = null;

    const el = {
      status: document.getElementById("status"),
      stepCode: document.getElementById("step-code"),
      codeInput: document.getElementById("code-input"),
      codeNext: document.getElementById("code-next"),
      codeError: document.getElementById("code-error"),
      stepName: document.getElementById("step-name"),
      nameInput: document.getElementById("name-input"),
      nameLogin: document.getElementById("name-login"),
      nameBack: document.getElementById("name-back"),
      nameError: document.getElementById("name-error"),
      profile: document.getElementById("profile"),
      meName: document.getElementById("me-name"),
      meCode: document.getElementById("me-code"),
      peerName: document.getElementById("peer-name"),
      logout: document.getElementById("logout"),
      chatPeer: document.getElementById("chat-peer"),
      presence: document.getElementById("presence"),
      messages: document.getElementById("messages"),
      msgInput: document.getElementById("msg-input"),
      sendBtn: document.getElementById("send-btn"),
      fileInput: document.getElementById("file-input"),
      fileList: document.getElementById("file-list"),
      startCall: document.getElementById("start-call"),
      endCall: document.getElementById("end-call"),
      remoteAudio: document.getElementById("remote-audio"),
    };

    function show(e) { e.classList.remove("hidden"); }
    function hide(e) { e.classList.add("hidden"); }
    function setStatus(t) { el.status.textContent = t; }
    function setPresence(t) { el.presence.textContent = t; }
    function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
    function addMessage(text, fromMe, meta = "") {
      const div = document.createElement("div");
      div.className = "msg " + (fromMe ? "me" : "them");
      div.innerHTML = `${escapeHtml(text)}${meta ? `<div class="meta">${escapeHtml(meta)}</div>` : ""}`;
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }
    function addFileEntry(name, size, url, fromMe) {
      const a = document.createElement("a");
      a.href = url; a.download = name; a.textContent = name;
      a.style.color = fromMe ? "#7bdcb5" : "#4db6ff";
      const row = document.createElement("div");
      row.appendChild(a);
      el.fileList.appendChild(row);
    }

    el.codeNext.addEventListener("click", () => {
      const code = (el.codeInput.value || "").trim();
      if (!VALID_CODES.includes(code)) {
        el.codeError.textContent = "ERROR";
        return;
      }
      el.codeError.textContent = "";
      hide(el.stepCode);
      show(el.stepName);
      el.nameInput.value = "";
      el.nameInput.dataset.expected = NAME_BY_CODE[code];
      el.nameInput.dataset.code = code;
      el.nameInput.focus();
    });

    el.nameBack.addEventListener("click", () => {
      hide(el.stepName);
      show(el.stepCode);
      el.codeInput.focus();
    });

    el.nameLogin.addEventListener("click", () => {
      const name = (el.nameInput.value || "").trim();
      const expected = el.nameInput.dataset.expected;
      const code = el.nameInput.dataset.code;
      if (!name || name !== expected) {
        el.nameError.textContent = "ERROR";
        return;
      }
      el.nameError.textContent = "";
      me = { code, name };
      localStorage.setItem("ct.me", JSON.stringify(me));
      setStatus(`Logged in as ${me.name}`);
      hide(el.stepName);
      show(el.profile);
      el.meName.textContent = me.name;
      el.meCode.textContent = me.code;
      initChannel();
      announcePresence();
    });

    el.logout.addEventListener("click", () => {
      localStorage.removeItem("ct.me");
      me = null; peer = null;
      teardownCall();
      if (channel) { channel.close(); channel = null; }
      el.peerName.textContent = "";
      el.chatPeer.textContent = "No peer";
      setPresence("");
      el.messages.innerHTML = "";
      el.fileList.innerHTML = "";
      hide(el.profile);
      show(el.stepCode);
      setStatus("Not logged in");
    });

    (function restore() {
      const saved = localStorage.getItem("ct.me");
      if (saved) {
        try {
          const s = JSON.parse(saved);
          if (s && VALID_CODES.includes(s.code) && NAME_BY_CODE[s.code] === s.name) {
            me = s;
            setStatus(`Logged in as ${me.name}`);
            hide(el.stepCode); hide(el.stepName); show(el.profile);
            el.meName.textContent = me.name; el.meCode.textContent = me.code;
            initChannel(); announcePresence();
          } else {
            localStorage.removeItem("ct.me");
          }
        } catch {}
      }
    })();

    el.sendBtn.addEventListener("click", () => {
      if (!me || !channel) return;
      const text = (el.msgInput.value || "").trim();
      if (!text) return;
      const msg = { type: "chat", from: me, text, ts: Date.now() };
      channel.postMessage(msg);
      addMessage(text, true, new Date(msg.ts).toLocaleTimeString());
      el.msgInput.value = "";
    });

    el.fileInput.addEventListener("change", async (e) => {
      if (!me || !channel) return;
      const file = e.target.files[0];
      if (!file) return;
      const arrayBuf = await file.arrayBuffer();
      const msg = {
        type: "file", from: me, name: file.name, size: file.size,
        mime: file.type || "application/octet-stream",
        data: Array.from(new Uint8Array(arrayBuf)), ts: Date.now(),
      };
      channel.postMessage(msg);
      const blob = new Blob([arrayBuf], { type: msg.mime });
      const url = URL.createObjectURL(blob);
      addFileEntry(file.name, file.size, url, true);
      addMessage(`Sent file: ${file.name}`, true, new Date(msg.ts).toLocaleTimeString());
      e.target.value = "";
    });

    function initChannel() {
      channel = new BroadcastChannel(CHANNEL_NAME);
      channel.onmessage = async (ev) => {
        const msg = ev.data;
        if (!msg || !msg.type) return;

        if (msg.type === "presence" && me) {
          if (!peer && msg.from.code !== me.code) {
            peer = msg.from;
            el.peerName.textContent = peer.name;
            el.chatPeer.textContent = peer.name;
            setPresence("");
          }
          return;
        }

        if (msg.type === "chat" && me) {
          if (msg.from.code !== me.code) {
            addMessage(msg.text, false, new Date(msg.ts).toLocaleTimeString());
          }
          return;
        }

        if (msg.type === "file" && me) {
          if (msg.from.code !== me.code) {
            const u8 = new Uint8Array(msg.data);
            const blob = new Blob([u8], { type: msg.mime });
            const url = URL.createObjectURL(blob);
            addFileEntry(msg.name, msg.size, url, false);
            addMessage(`Received file: ${msg.name}`, false, new Date(msg.ts).toLocaleTimeString());
          }
          return;
        }

        if (msg.type === "rtc-offer" && me) {
          if (msg.from.code === me.code) return;
          await ensurePeerConnection();
          await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          channel.postMessage({ type: "rtc-answer", from: me, sdp: pc.localDescription });
          return;
        }
        if (msg.type === "rtc-answer" && me) {
          if (msg.from.code === me.code) return;
          if (!pc) return;
          await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
          return;
        }
        if (msg.type === "rtc-ice" && me) {
          if (msg.from.code === me.code) return;
          if (!pc) return;
          try { await pc.addIceCandidate(msg.candidate); } catch {}
          return;
        }
      };
    }

    function announcePresence() {
      if (!channel || !me) return;
      channel.postMessage({ type: "presence", from: me, ts: Date.now() });
    }

    el.startCall.addEventListener("click", async () => {
      if (!me || !channel) return;
      await ensurePeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      channel.postMessage({ type: "rtc-offer", from: me, sdp: pc.localDescription });
    });

    el.endCall.addEventListener("click", () => { teardownCall(); });

    async function ensurePeerConnection() {
      if (pc) return pc;
      pc = new RTCPeerConnection({ iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] });
      pc.onicecandidate = (e) => { if (e.candidate) channel.postMessage({ type: "rtc-ice", from: me, candidate: e.candidate }); };
      pc.ontrack = (ev) => { el.remoteAudio.srcObject = ev.streams[0]; };
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      } catch {
        addMessage("Microphone unavailable.", true);
      }
      return pc;
    }

    function teardownCall() {
      if (pc) { pc.getSenders().forEach(s => { try { s.track.stop(); } catch {} }); pc.close(); pc = null; }
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      el.remoteAudio.srcObject = null;
    }
  </script>
</body>
</html>